# Copyright 2023 Google LLC
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     https://www.apache.org/licenses/LICENSE-2.0
#
#     Unless required by applicable law or agreed to in writing, software
#     distributed under the License is distributed on an "AS IS" BASIS,
#     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
#     See the License for the specific language governing permissions and
#     limitations under the License.

âŸ¨TestSuiteâŸ© â† â€¢Import "../test.bqn"

ts â† TestSuite "Under"


# Two combinators which are particularly useful with âŒ¾ are âŠ¸ (Before) and âŸœ
# (After). These combinators have several purposes, all related to applying a
# function to one argument before passing to another function. ğ”½âŠ¸ğ”¾ ğ•© is
# equivalent to (ğ”½ ğ•©) ğ”¾ ğ•©, and ğ•¨ ğ”½âŠ¸ğ”¾ ğ•© is equivalent to (ğ”½ ğ•¨) ğ”¾ ğ•©. Similarly,
# ğ”½âŸœğ”¾ ğ•© is equivalent to ğ•© ğ”½ (ğ”¾ ğ•©) and ğ•¨ ğ”½âŸœğ”¾ ğ•© is equivalent to ğ•¨ ğ”½ (ğ”¾ ğ•©).
# Graphically,
#
#       ğ”½âŠ¸ğ”¾ ğ•©    ğ•¨ ğ”½âŠ¸ğ”¾ ğ•©    ğ”½âŸœğ”¾ ğ•©    ğ•¨ ğ”½âŸœğ”¾ ğ•©
#
#        ğ”¾          ğ”¾        ğ”½          ğ”½
#       â•± â•²        â•± â•²      â•± â•²        â•± â•²
#      ğ”½   ğ•©      ğ”½   ğ•©    ğ•©   ğ”¾      ğ•¨   ğ”¾
#      â”‚          â”‚            â”‚          â”‚
#      ğ•©          ğ•¨            ğ•©          ğ•©
#
# In short, âŠ¸ and âŸœ apply a function to the left or right argument, respectively,
# before passing it to a function.  Remember that the function which is applied
# first is at the pointy end of the combinator.

{ ğ•¤ â‹„
  âˆ = 2 Ã·âŠ¸Ã— 6
} ts._Test "Preprocessing left side"

{ ğ•¤ â‹„
  âˆ = 2âŠ¸âŠ‘ 2â€¿7â€¿1â€¿8â€¿2
} ts._Test "With value to bind argument"


# If only one argument is given to a verb modified with âŠ¸ or âŸœ, then that
# argument is applied to both sides of the verb.

{ ğ•¤ â‹„
  3â€¿3 â‰¡ -âŠ¸â‹ˆ 3
} ts._Test "Comparing negation"

{ ğ•¤ â‹„
  9â€¿9 â‰¡ â‹ˆâŸœâˆš 9
} ts._Test "Comparing square root"

{ ğ•¤ â‹„
  2â€¿2 â‰¡ Ã—ËœâŠ¸â‹ˆ 2
} ts._Test "Comparing square"


# We can use âŸœ in conjunction with âŠ‘ and âŒ¾ to build a modified array at a given
# index.

{ ğ•¤ â‹„
  nums â† 1â€¿1â€¿2â€¿0â€¿5â€¿8â€¿13
  1â€¿1â€¿2â€¿0â€¿5â€¿8â€¿13 â‰¡ 3âŒ¾(3âŠ¸âŠ‘) nums
} ts._Test "Update the fourth element"

{ ğ•¤ â‹„
  âˆâ€¿âˆâ€¿âˆ â‰¡ 1âŒ¾âŠ‘ 2âŒ¾(1âŠ¸âŠ‘) 3âŒ¾(2âŠ¸âŠ‘) 0â€¿0â€¿0
} ts._Test "Multiple updates"

{ ğ•¤ â‹„
  âˆ â‰¡ 0â€¿0âŒ¾(Â¯1âŠ¸âŠ) 3â€¿2 â¥Š 1
} ts._Test "Update last element"


# Combinations of âŠ¸ and âŸœ can be somewhat complex, but some patterns are more
# useful than others. Take the combination FâŠ¸GâŸœH as an example. The normal
# order of application for verbs is from right to left. But modifiers are
# applied from left to right. So FâŠ¸GâŸœH is equivalent to (FâŠ¸G)âŸœH.  Graphically,
#
#     ((FâŠ¸G)âŸœH) ğ•©            ğ•¨ ((FâŠ¸G)âŸœH) ğ•©
#
#       (GâŠ¸H)                    (GâŠ¸H)
#        â•± â•²                      â•± â•²
#       ğ”½   ğ•©                    ğ”½   ğ•©
#       â”‚                        â”‚
#       ğ•©                        ğ•¨
#
# Which, expanding GâŸœH, is equivalent to
#
#      (FâŠ¸GâŸœH) ğ•©            ğ•¨ (FâŠ¸GâŸœH) ğ•©
#
#         G                      G
#        / \                    / \
#       F   H                  F   H
#      /     \                /     \
#     ğ•©       ğ•©              ğ•¨       ğ•©
#
# FâŠ¸GâŸœH, then, is a way to preprocess arguments with different verbs.  In that
# way, it's similar to dyadic â—‹: ğ•¨ (Fâ—‹G) ğ•© could be rewritten ğ•¨ (GâŠ¸FâŸœG) ğ•©.

{ ğ•¤ â‹„
  Square â† â‹†âŸœ2
  DiffOfSquare1 â† -â—‹Square
  DiffOfSquare2 â† âˆË™
  3 (DiffOfSquare1 = DiffOfSquare2) 2
} ts._Test "Bind-over equivalence"


# Another useful pattern is FâŸœGâŸœH.  Since modifiers are applied left to right,
# it's equivalent to (FâŸœG)âŸœH.  Effectively, this preprocesses the left argument
# twice.

{ ğ•¤ â‹„
  Square â† â‹†âŸœ2
  âˆ = 3 (-âŸœâˆšâŸœSquare) Â¯2
} ts._Test "Preprocessing the right"


# However, FâŠ¸GâŠ¸H isn't quite the same.  The following are equivalent versions of
# the dyad:
#
#     ğ•¨ FâŠ¸GâŠ¸H ğ•©
#     ğ•¨ (FâŠ¸G)âŠ¸H ğ•©                 By modifier application
#     ((FâŠ¸G) ğ•¨) H ğ•©               By definition of âŠ¸
#     ((F ğ•¨) G ğ•¨) H ğ•©             By definition of âŠ¸
#
# Which is a good deal more complex.

{ ğ•¤ â‹„
  âˆ â‰¡ 3 -âŠ¸Ã—âŠ¸Ã· 9
} ts._Test ""


ts.Report @
